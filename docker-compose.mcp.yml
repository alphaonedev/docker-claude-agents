###############################################################################
# Docker Claude Agents — MCP Services Overlay
#
# Extends the base compose with Model Context Protocol tool servers.
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.mcp.yml up --build
#
# Prerequisites (set in .env):
#   GITHUB_TOKEN, BRAVE_API_KEY, POSTGRES_PASSWORD
###############################################################################

services:

  # ── GitHub MCP — repo, issue, PR access ────────────────────────────────────
  mcp-github:
    image: mcp/github-server:latest
    restart: on-failure:3
    security_opt: [no-new-privileges:true]
    cap_drop: [ALL]
    read_only: true
    pids_limit: 128
    environment:
      GITHUB_PERSONAL_ACCESS_TOKEN: ${GITHUB_TOKEN:?GITHUB_TOKEN required}
    networks: [agent-net]
    healthcheck:
      test: ["CMD-SHELL", "pgrep -x node > /dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M

  # ── Filesystem MCP — structured file operations ────────────────────────────
  mcp-filesystem:
    image: mcp/filesystem-server:latest
    restart: on-failure:3
    security_opt: [no-new-privileges:true]
    cap_drop: [ALL]
    read_only: true
    pids_limit: 128
    command: ["/app/workspace"]
    volumes:
      - ./workspace:/app/workspace
    networks: [agent-net]
    healthcheck:
      test: ["CMD-SHELL", "pgrep -x node > /dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

  # ── Brave Search MCP — web search ──────────────────────────────────────────
  mcp-search:
    image: mcp/brave-search-server:latest
    restart: on-failure:3
    security_opt: [no-new-privileges:true]
    cap_drop: [ALL]
    read_only: true
    pids_limit: 128
    environment:
      BRAVE_API_KEY: ${BRAVE_API_KEY:?BRAVE_API_KEY required}
    networks: [agent-net]
    healthcheck:
      test: ["CMD-SHELL", "pgrep -x node > /dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

  # ── PostgreSQL MCP — database queries ──────────────────────────────────────
  mcp-postgres:
    image: mcp/postgres-server:latest
    restart: on-failure:3
    security_opt: [no-new-privileges:true]
    cap_drop: [ALL]
    read_only: true
    pids_limit: 128
    environment:
      DATABASE_URL: "postgres://${POSTGRES_USER:-claude_agent}:${POSTGRES_PASSWORD:?POSTGRES_PASSWORD required}@db-service:5432/${POSTGRES_DB:-agentdb}"
    networks: [agent-net]
    depends_on:
      db-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "pgrep -x node > /dev/null || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 15s
      retries: 3
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "3"
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

  # ── PostgreSQL backing service ─────────────────────────────────────────────
  db-service:
    image: postgres:15-alpine
    restart: unless-stopped
    security_opt: [no-new-privileges:true]
    cap_drop: [ALL]
    cap_add: [SETUID, SETGID, FOWNER, DAC_READ_SEARCH]
    pids_limit: 128
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-claude_agent}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD required}
      POSTGRES_DB: ${POSTGRES_DB:-agentdb}
    networks: [agent-net]
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-claude_agent} -d ${POSTGRES_DB:-agentdb}"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    volumes:
      - db-data:/var/lib/postgresql/data
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "5"
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 1G

volumes:
  db-data:
    driver: local
    labels:
      com.claude-agents.purpose: "PostgreSQL persistent storage"
