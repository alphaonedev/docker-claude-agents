name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate JSON schemas
        run: |
          for f in schemas/*.json; do
            echo "Validating $f..."
            jq empty "$f" || exit 1
          done
          echo "All schemas valid."

      - name: Validate example task files
        run: |
          for f in examples/*.json; do
            echo "Validating $f..."
            jq empty "$f" || exit 1
          done
          echo "All examples valid."

      - name: Validate MCP config
        run: jq empty mcp-config.json

      - name: Validate Docker Compose files
        run: |
          # Create minimal .env for config validation
          echo "ANTHROPIC_API_KEY=test-key-for-validation" > .env
          echo "GITHUB_TOKEN=test-token" >> .env
          echo "BRAVE_API_KEY=test-key" >> .env
          echo "POSTGRES_PASSWORD=test-pass" >> .env

          echo "Validating docker-compose.yml..."
          docker compose config --quiet

          echo "Validating docker-compose.chat.yml..."
          docker compose -f docker-compose.chat.yml config --quiet

          echo "Validating docker-compose.cowork.yml..."
          docker compose -f docker-compose.cowork.yml config --quiet

          echo "Validating docker-compose.mcp.yml (overlay)..."
          docker compose -f docker-compose.yml -f docker-compose.mcp.yml config --quiet

          echo "All compose files valid."

  lint:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Lint scripts
        run: shellcheck scripts/*.sh

  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [validate]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build base image
        run: docker build -f Dockerfile.base -t claude-agent-base .

      - name: Build agent images
        run: |
          for agent in master-controller researcher coder reviewer tester deployer; do
            echo "Building $agent..."
            docker build -t "claude-agent-${agent}" "./agents/${agent}/"
          done
          echo "All agent images built."

  structure:
    name: Verify Project Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check required files exist
        run: |
          REQUIRED_FILES=(
            "Makefile"
            "Dockerfile.base"
            "docker-compose.yml"
            "docker-compose.chat.yml"
            "docker-compose.cowork.yml"
            "docker-compose.mcp.yml"
            ".env.example"
            ".dockerignore"
            ".gitignore"
            "mcp-config.json"
            "README.md"
            "LICENSE"
            "schemas/task.schema.json"
            "schemas/status.schema.json"
            "schemas/output.schema.json"
            "scripts/lib.sh"
            "scripts/start-all.sh"
            "scripts/cleanup.sh"
            "docs/ARCHITECTURE.md"
            "docs/SECURITY.md"
            "docs/TROUBLESHOOTING.md"
          )

          AGENTS=(master-controller researcher coder reviewer tester deployer)

          for f in "${REQUIRED_FILES[@]}"; do
            [ -f "$f" ] || { echo "MISSING: $f"; exit 1; }
          done

          for agent in "${AGENTS[@]}"; do
            for f in Dockerfile system-prompt.md CLAUDE.md; do
              [ -f "agents/$agent/$f" ] || { echo "MISSING: agents/$agent/$f"; exit 1; }
            done
          done

          echo "All required files present."

      - name: Check scripts are executable
        run: |
          for f in scripts/*.sh; do
            [ -x "$f" ] || { echo "NOT EXECUTABLE: $f"; exit 1; }
          done
          echo "All scripts executable."
