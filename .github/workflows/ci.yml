name: CI

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate JSON schemas
        run: |
          for f in schemas/*.json examples/*.json mcp-config.json; do
            echo "Validating $f..."
            jq empty "$f" || exit 1
          done
          echo "All JSON valid."

      - name: Validate Docker Compose files
        run: |
          cat > .env <<'ENVEOF'
          ANTHROPIC_API_KEY=test-key
          GITHUB_TOKEN=test-token
          BRAVE_API_KEY=test-key
          POSTGRES_PASSWORD=test-pass
          OPENAI_API_KEY=test-key
          LANGCHAIN_API_KEY=test-key
          LANGGRAPH_POSTGRES_PASSWORD=test-pass
          AZURE_OPENAI_ENDPOINT=https://test.openai.azure.com/
          AZURE_OPENAI_API_KEY=test-key
          ENVEOF

          for desc_file in \
            "docker-compose.yml" \
            "docker-compose.chat.yml" \
            "docker-compose.cowork.yml" \
            "docker-compose.yml -f docker-compose.mcp.yml" \
            "docker-compose.yml -f docker-compose.langgraph.yml" \
            "docker-compose.yml -f docker-compose.msagent.yml" \
            "docker-compose.yml -f docker-compose.langgraph.yml -f docker-compose.msagent.yml"; do
            echo "Validating ${desc_file}..."
            docker compose -f ${desc_file} config --quiet || exit 1
          done
          echo "All compose files valid."

  lint:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck
      - name: Lint scripts
        run: shellcheck -x scripts/*.sh

  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [validate]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build base image
        run: |
          docker build -f Dockerfile.base -t claude-agent-base \
            --build-arg BUILD_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            --build-arg VCS_REF="${GITHUB_SHA:-unknown}" \
            .

      - name: Build agent images
        run: |
          for agent in master-controller researcher coder reviewer tester deployer; do
            echo "Building $agent..."
            docker build -t "claude-agent-${agent}" "./agents/${agent}/" || exit 1
          done
          echo "All agent images built."

  scan:
    name: Image Security Scan
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - uses: actions/checkout@v4

      - name: Build base image for scanning
        run: |
          docker build -f Dockerfile.base -t claude-agent-base \
            --build-arg BUILD_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
            .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: "claude-agent-base"
          format: "table"
          exit-code: "1"
          severity: "CRITICAL,HIGH"
          ignore-unfixed: true

  structure:
    name: Verify Project Structure
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check required files exist
        run: |
          REQUIRED_FILES=(
            "Makefile"
            "Dockerfile.base"
            "docker-compose.yml"
            "docker-compose.chat.yml"
            "docker-compose.cowork.yml"
            "docker-compose.mcp.yml"
            "docker-compose.langgraph.yml"
            "docker-compose.msagent.yml"
            "frameworks/langgraph/langgraph.json"
            "frameworks/langgraph/graph.py"
            "frameworks/langgraph/requirements.txt"
            "frameworks/msagent/Dockerfile"
            "frameworks/msagent/requirements.txt"
            "frameworks/msagent/msagent/server.py"
            ".env.example"
            ".dockerignore"
            ".gitignore"
            "mcp-config.json"
            "README.md"
            "LICENSE"
            "VERSION"
            "CHANGELOG.md"
            "CONTRIBUTING.md"
            "schemas/task.schema.json"
            "schemas/status.schema.json"
            "schemas/output.schema.json"
            "scripts/lib.sh"
            "scripts/start-all.sh"
            "scripts/cleanup.sh"
            "docs/ARCHITECTURE.md"
            "docs/SECURITY.md"
            "docs/TROUBLESHOOTING.md"
          )

          AGENTS=(master-controller researcher coder reviewer tester deployer)

          FAIL=0
          for f in "${REQUIRED_FILES[@]}"; do
            [ -f "$f" ] || { echo "MISSING: $f"; FAIL=1; }
          done

          for agent in "${AGENTS[@]}"; do
            for f in Dockerfile system-prompt.md CLAUDE.md; do
              [ -f "agents/$agent/$f" ] || { echo "MISSING: agents/$agent/$f"; FAIL=1; }
            done
          done

          [ "$FAIL" -eq 0 ] || exit 1
          echo "All required files present."

      - name: Check scripts are executable
        run: |
          FAIL=0
          for f in scripts/*.sh; do
            [ -x "$f" ] || { echo "NOT EXECUTABLE: $f"; FAIL=1; }
          done
          [ "$FAIL" -eq 0 ] || exit 1
          echo "All scripts executable."
