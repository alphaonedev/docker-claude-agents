###############################################################################
# Docker Claude Agents - Cowork Mode (Pair Programming)
#
# Usage:
#   docker compose -f docker-compose.cowork.yml up --build
#
# Launches two agents that collaborate on the same workspace:
# - A "lead" agent that plans and implements
# - A "reviewer" agent that reviews and suggests improvements
#
# They communicate through shared task/status volumes.
###############################################################################

services:
  # Lead agent - plans and implements
  lead-agent:
    build:
      context: ./agents/coder
      dockerfile: Dockerfile
    container_name: claude_lead
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_AGENT_ROLE=lead
    volumes:
      - ./.claude:/home/node/.claude
      - ./workspace:/app/workspace
      - cowork-tasks:/app/tasks
      - cowork-status:/app/status
      - cowork-output:/app/output
    networks:
      - agent-net
    command: >
      --dangerously-skip-permissions
      "You are the lead developer. Read the task from /app/tasks/lead/incoming.json. Implement the solution in /app/workspace/. When done, write a summary to /app/output/lead/summary.md and set your status to completed in /app/status/lead/current.json."
    depends_on:
      cowork-init:
        condition: service_completed_successfully

  # Review agent - reviews and improves
  review-agent:
    build:
      context: ./agents/reviewer
      dockerfile: Dockerfile
    container_name: claude_review
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_AGENT_ROLE=reviewer
    volumes:
      - ./.claude:/home/node/.claude
      - ./workspace:/app/workspace
      - cowork-tasks:/app/tasks
      - cowork-status:/app/status
      - cowork-output:/app/output
    networks:
      - agent-net
    command: >
      --dangerously-skip-permissions
      "You are the code reviewer. Wait for the lead agent to complete by checking /app/status/lead/current.json. Once complete, review the code in /app/workspace/ and the summary in /app/output/lead/summary.md. Write your review to /app/output/reviewer/review.md."
    depends_on:
      cowork-init:
        condition: service_completed_successfully

  cowork-init:
    image: node:22-slim
    volumes:
      - cowork-tasks:/app/tasks
      - cowork-status:/app/status
      - cowork-output:/app/output
    command: >
      sh -c "
        mkdir -p /app/tasks/{lead,reviewer} &&
        mkdir -p /app/status/{lead,reviewer} &&
        mkdir -p /app/output/{lead,reviewer} &&
        echo 'Cowork directories initialized'
      "

volumes:
  cowork-tasks:
    driver: local
  cowork-status:
    driver: local
  cowork-output:
    driver: local

networks:
  agent-net:
    driver: bridge
