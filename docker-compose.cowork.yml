###############################################################################
# Docker Claude Agents — Cowork Mode (Pair Programming)
#
# Two-agent collaboration: a Lead implements, a Reviewer validates.
#
# Usage:
#   docker compose -f docker-compose.cowork.yml up --build
###############################################################################

x-cowork-defaults: &cowork-defaults
  restart: on-failure:3
  networks: [agent-net]
  security_opt:
    - no-new-privileges:true
  cap_drop: [ALL]
  read_only: true
  pids_limit: 256
  tmpfs:
    - /tmp:size=100M,noexec,nosuid
    - /home/node/.config:size=50M,noexec,nosuid
    - /home/node/.cache:size=100M,noexec,nosuid
    - /home/node/.npm:size=50M,noexec,nosuid
    - /home/node/.local:size=50M,noexec,nosuid
  logging:
    driver: json-file
    options:
      max-size: "10m"
      max-file: "3"
      tag: "{{.Name}}"
  deploy:
    resources:
      limits:
        cpus: "2"
        memory: 4G
      reservations:
        cpus: "0.5"
        memory: 512M
  depends_on:
    cowork-init:
      condition: service_completed_successfully

x-cowork-environment: &cowork-environment
  ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:?Set ANTHROPIC_API_KEY in .env}

x-cowork-volumes: &cowork-volumes
  - ./.claude:/home/node/.claude:ro
  - ./workspace:/app/workspace
  - cowork-tasks:/app/tasks
  - cowork-status:/app/status
  - cowork-output:/app/output

services:

  # ── Init ───────────────────────────────────────────────────────────────────
  cowork-init:
    image: alpine:3.19
    read_only: true
    security_opt: [no-new-privileges:true]
    cap_drop: [ALL]
    volumes:
      - cowork-tasks:/app/tasks
      - cowork-status:/app/status
      - cowork-output:/app/output
    entrypoint: ["/bin/sh", "-euxc"]
    command:
      - |
        for agent in lead reviewer; do
          mkdir -p "/app/tasks/$${agent}" "/app/status/$${agent}" "/app/output/$${agent}"
        done

  # ── Lead Agent — plans and implements ──────────────────────────────────────
  lead-agent:
    <<: *cowork-defaults
    build:
      context: ./agents/coder
      args:
        CLAUDE_CODE_VERSION: ${CLAUDE_CODE_VERSION:-latest}
    environment:
      <<: *cowork-environment
      CLAUDE_AGENT_ROLE: lead
    volumes: *cowork-volumes
    command:
      - "--dangerously-skip-permissions"
      - "Read the task from /app/tasks/lead/incoming.json. Implement the solution in /app/workspace/. Write a summary to /app/output/lead/summary.md. Write {\"status\":\"completed\"} to /app/status/lead/current.json when finished."

  # ── Review Agent — reviews and validates ───────────────────────────────────
  review-agent:
    <<: *cowork-defaults
    build:
      context: ./agents/reviewer
      args:
        CLAUDE_CODE_VERSION: ${CLAUDE_CODE_VERSION:-latest}
    environment:
      <<: *cowork-environment
      CLAUDE_AGENT_ROLE: reviewer
    volumes: *cowork-volumes
    command:
      - "--dangerously-skip-permissions"
      - "Poll /app/status/lead/current.json until status is 'completed' (check every 10s, timeout after 10 minutes). Then review code in /app/workspace/ and the summary at /app/output/lead/summary.md. Write your review to /app/output/reviewer/review.md."

volumes:
  cowork-tasks:
    driver: local
  cowork-status:
    driver: local
  cowork-output:
    driver: local

networks:
  agent-net:
    driver: bridge
