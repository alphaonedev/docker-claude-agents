###############################################################################
# Docker Claude Agents — Cowork Mode (Pair Programming)
#
# Two-agent collaboration: a Lead implements, a Reviewer validates.
#
# Usage:
#   docker compose -f docker-compose.cowork.yml up --build
###############################################################################

x-cowork-defaults: &cowork-defaults
  restart: on-failure:3
  networks:
    - agent-net
  logging:
    driver: json-file
    options:
      max-size: "10m"
      max-file: "3"
  deploy:
    resources:
      limits:
        cpus: "2"
        memory: 4G
      reservations:
        cpus: "0.5"
        memory: 512M
  depends_on:
    cowork-init:
      condition: service_completed_successfully

x-cowork-environment: &cowork-environment
  ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:?ANTHROPIC_API_KEY is required — see .env.example}

x-cowork-volumes: &cowork-volumes
  - ./.claude:/home/node/.claude:ro
  - ./workspace:/app/workspace
  - cowork-tasks:/app/tasks
  - cowork-status:/app/status
  - cowork-output:/app/output

services:

  # ── Init service ──────────────────────────────────────────────────────────
  cowork-init:
    image: alpine:3.19
    volumes:
      - cowork-tasks:/app/tasks
      - cowork-status:/app/status
      - cowork-output:/app/output
    entrypoint: ["/bin/sh", "-euxc"]
    command:
      - |
        for agent in lead reviewer; do
          mkdir -p "/app/tasks/$${agent}" "/app/status/$${agent}" "/app/output/$${agent}"
        done
        echo "[init] Cowork volumes ready"

  # ── Lead Agent — Plans and implements ─────────────────────────────────────
  lead-agent:
    <<: *cowork-defaults
    build:
      context: ./agents/coder
      args:
        CLAUDE_CODE_VERSION: ${CLAUDE_CODE_VERSION:-latest}
    environment:
      <<: *cowork-environment
      CLAUDE_AGENT_ROLE: lead
    volumes: *cowork-volumes
    command:
      - "--dangerously-skip-permissions"
      - "Read the task from /app/tasks/lead/incoming.json. Implement the solution in /app/workspace/. Write a summary to /app/output/lead/summary.md. Write {\"status\":\"completed\"} to /app/status/lead/current.json when finished."

  # ── Review Agent — Reviews and validates ──────────────────────────────────
  review-agent:
    <<: *cowork-defaults
    build:
      context: ./agents/reviewer
      args:
        CLAUDE_CODE_VERSION: ${CLAUDE_CODE_VERSION:-latest}
    environment:
      <<: *cowork-environment
      CLAUDE_AGENT_ROLE: reviewer
    volumes: *cowork-volumes
    command:
      - "--dangerously-skip-permissions"
      - "Poll /app/status/lead/current.json until the lead agent status is 'completed' (check every 10 seconds, timeout after 10 minutes). Then review code in /app/workspace/ and the summary at /app/output/lead/summary.md. Write your review to /app/output/reviewer/review.md."

volumes:
  cowork-tasks:
    driver: local
  cowork-status:
    driver: local
  cowork-output:
    driver: local

networks:
  agent-net:
    driver: bridge
